---
title: "PCA"
output: html_document
---

```{r}
load("/data/msun/projects/pandas/geraldine/01_preprocess/preprocess_filtered.Rdata")

```

#PCA for all tissue
```{r}
#PCA for muscle samples
library(Polychrome)
col = as.character(createPalette(24,  c("#ff0000", "#00ff00", "#0000ff")))
cols=c("BF"=col[1],"ST"=col[2],"SM"=col[3],"TA"=col[4],"EDL"=col[5],"Gas"=col[6],"Sol"=col[7],"Quad"=col[8],"Dia"=col[9],"Adrenal"=col[10],"BrownAdip"=col[11],"Cerebel"=col[12],"Cortex"=col[13],"epididWAT"=col[14],"Hypothal"=col[15],"inguinWAT"=col[16],"Pituitary"=col[17],"Heart"=col[18],"Kid"=col[19],"Liver"=col[20],"Lung"=col[21],"GasTen"=col[22],"TATen"=col[23], "EDLTen"=col[24])

samplenames <- colnames(expr)
tissue <- sapply(samplenames,function(samplenames){
  as.character(dge.norm$samples[rownames(dge.norm$samples) == samplenames,"Tissue"])
})

group <- sapply(samplenames,function(samplenames){
  as.character(dge.norm$samples[rownames(dge.norm$samples) == samplenames,"Group"])
})
sex <- sapply(samplenames,function(samplenames){
  as.character(dge.norm$samples[rownames(dge.norm$samples) == samplenames,"Sex"])
})

library(factoextra)
pca <- prcomp(t(expr))#PCA
fviz_screeplot(pca, addlabels = TRUE)

pca_df<-as.data.frame(pca$x) 
pca.contrib <- pca$sdev %>% .^2 %>% {./sum(.) * 100} %>% .[1:4] %>% signif(digits = 4)
p <- ggplot(data = pca_df, aes(x = PC1, y = PC2)) +
  geom_point(size = 3,aes(colour = as.character(tissue),shape = interaction(as.character(group),sex), fill = as.character(tissue))) + 
  scale_shape_manual(name="Group/Gender",values = c(16,21,17,24),
                     labels=c("RW,F","Sed,F","RW,M","Sed,M")) +
  scale_colour_manual(name="Tissue",values = cols) + 
  scale_fill_manual(name="Gender",values = rep("white",length(cols)),guide=FALSE) + 
  theme(panel.grid = element_blank(), panel.background = element_rect(color = 'black', fill = 'transparent'), 
    legend.key = element_rect(fill = 'transparent')) +  
  labs(x =  paste('PC1:',round(pca.contrib[1], 2),'%'), y = paste('PC2:',round(pca.contrib[2], 2),'%'), color = '')+
  ggtitle("PCA plot of all tissues")

p
ggsave("/data/msun/projects/pandas/geraldine/01_PCA/2DPCA.pdf",p,width = 7.5,height = 5)

```

#PCA for all tissue except cortex and cerebellum
```{r}
dge_muscle <- expr[,!colnames(expr) %in% rownames(dge$samples[dge$samples$Tissue %in% c("Cortex","Cerebel"),])]

library(Polychrome)
col = as.character(createPalette(24,  c("#ff0000", "#00ff00", "#0000ff")))
cols=c("BF"=col[1],"ST"=col[2],"SM"=col[3],"TA"=col[4],"EDL"=col[5],"Gas"=col[6],"Sol"=col[7],"Quad"=col[8],"Dia"=col[9],"Adrenal"=col[10],"BrownAdip"=col[11],"epididWAT"=col[14],"Hypothal"=col[15],"inguinWAT"=col[16],"Pituitary"=col[17],"Heart"=col[18],"Kid"=col[19],"Liver"=col[20],"Lung"=col[21],"GasTen"=col[22],"TATen"=col[23], "EDLTen"=col[24])

samplenames_muscle <- colnames(dge_muscle)
tissue <- sapply(samplenames_muscle,function(samplenames_muscle){
  as.character(dge.norm$samples[rownames(dge.norm$samples) == samplenames_muscle,"Tissue"])
})

group <- sapply(samplenames_muscle,function(samplenames_muscle){
  as.character(dge.norm$samples[rownames(dge.norm$samples) == samplenames_muscle,"Group"])
})
sex <- sapply(samplenames_muscle,function(samplenames_muscle){
  as.character(dge.norm$samples[rownames(dge.norm$samples) == samplenames_muscle,"Sex"])
})

library(factoextra)
muscle.pca <- prcomp(t(dge_muscle))#PCA
fviz_screeplot(muscle.pca, addlabels = TRUE)

pca_df_muscle<-as.data.frame(muscle.pca$x) 
muscle.pca.contrib <- muscle.pca$sdev %>% .^2 %>% {./sum(.) * 100} %>% .[1:4] %>% signif(digits = 4)
p <- ggplot(data = pca_df_muscle, aes(x = PC1, y = PC2)) +
  geom_point(size = 3,aes(color = as.character(tissue),shape = interaction(as.character(group),sex), fill = as.character(tissue))) + 
  scale_shape_manual(name="Group/Gender",values = c(16,21,17,24),
                     labels=c("RW,F","Sed,F","RW,M","Sed,M")) +
  scale_colour_manual(name="Tissue",values = cols) + 
  scale_fill_manual(name="Gender",values = rep("white",length(cols)),guide=FALSE) + 
  theme(panel.grid = element_blank(), panel.background = element_rect(color = 'black', fill = 'transparent'), 
    legend.key = element_rect(fill = 'transparent')) +  
  labs(x =  paste('PC1:',round(muscle.pca.contrib[1], 2),'%'), y = paste('PC2:',round(muscle.pca.contrib[2], 2),'%'), color = '')+
  ggtitle("PCA plot of all muscles")

p
ggsave("/data/msun/projects/pandas/geraldine/01_PCA/2DPCA_expcept_cortexcere.pdf",p,width = 7.5,height = 5)

```

# PCA for muscle data
q: should I re-normalized data by TMM if I subset a small group of all normalized data?
a:The Trimmed Mean of the M-values (TMM) approach is to choose a sample as a reference sample, then calculate fold changes and absolute expression levels relative to that sample. The genes are trimmed twice by these two values, to remove DE genes, then the trimmed mean of the fold changes is found for each sample. Read counts are scaled by this trimmed mean and the total count of their sample.

```{r  dpi=300}
#PCA for muscle samples
dge_muscle <- expr[,colnames(expr) %in% rownames(dge$samples[dge$samples$Tissue %in% c("BF","ST","SM","TA","EDL","Gas","Sol","Quad","Dia"),])]

library(Polychrome)
col = as.character(createPalette(24,  c("#ff0000", "#00ff00", "#0000ff")))
cols=c("BF"=col[1],"ST"=col[2],"SM"=col[3],"TA"=col[4],"EDL"=col[5],"Gas"=col[6],"Sol"=col[7],"Quad"=col[8],"Dia"=col[9])

samplenames_muscle <- colnames(dge_muscle)
tissue <- sapply(samplenames_muscle,function(samplenames_muscle){
  as.character(dge.norm$samples[rownames(dge.norm$samples) == samplenames_muscle,"Tissue"])
})

group <- sapply(samplenames_muscle,function(samplenames_muscle){
  as.character(dge.norm$samples[rownames(dge.norm$samples) == samplenames_muscle,"Group"])
})
sex <- sapply(samplenames_muscle,function(samplenames_muscle){
  as.character(dge.norm$samples[rownames(dge.norm$samples) == samplenames_muscle,"Sex"])
})

library(factoextra)
muscle.pca <- prcomp(t(dge_muscle))#PCA
fviz_screeplot(muscle.pca, addlabels = TRUE)

pca_df_muscle<-as.data.frame(muscle.pca$x) 
muscle.pca.contrib <- muscle.pca$sdev %>% .^2 %>% {./sum(.) * 100} %>% .[1:4] %>% signif(digits = 4)
p <- ggplot(data = pca_df_muscle, aes(x = PC1, y = PC2)) +
  geom_point(size = 3,aes(color = as.character(tissue),shape = interaction(as.character(group),sex), fill = as.character(tissue))) + 
  scale_shape_manual(name="Group/Gender",values = c(16,21,17,24),
                     labels=c("RW,F","Sed,F","RW,M","Sed,M")) +
  scale_colour_manual(name="Tissue",values = cols) + 
  scale_fill_manual(name="Gender",values = rep("white",length(cols)),guide=FALSE) + 
  theme(panel.grid = element_blank(), panel.background = element_rect(color = 'black', fill = 'transparent'), 
    legend.key = element_rect(fill = 'transparent')) +  
  labs(x =  paste('PC1:',round(muscle.pca.contrib[1], 2),'%'), y = paste('PC2:',round(muscle.pca.contrib[2], 2),'%'), color = '')+
  ggtitle("PCA plot of all muscles")

p
ggsave("/data/msun/projects/pandas/geraldine/01_PCA/2DPCA_muscle.pdf",p,width = 6.5,height = 5)

library(scatterplot3d) #3DPCA
pdf("/data/msun/projects/pandas/geraldine/01_preprocess/3DPCA_muscle.pdf",width = 7,height = 4.5)
color=as.character(group_muscle) %>% gsub("BF","#FF7F24",.) %>% gsub("ST","#7FFFD4",.) %>% gsub("SM","#CAFF70",.) %>% gsub("TA","#FFB90F",.) %>% gsub("EDL","#BF3EFF",.) %>% gsub("Gas","#0000FF",.) %>% gsub("Sol","#FF4040",.) %>% gsub("Quad","#006400",.) %>% gsub("Dia","#FFD39B",.)  
scatterplot3d(pca_df_muscle$PC1, pca_df_muscle$PC2, pca_df_muscle$PC3,       
              color = color, pch=16,
              angle=50,cex.symbols=1.5,cex.axis=0.6, 
             xlab = paste('PC1:',round(muscle.pca.contrib[1], 2),'%'), 
             ylab = paste('PC2:',round(muscle.pca.contrib[2], 2),'%'), 
             zlab = paste('PC3:',round(muscle.pca.contrib[3], 2),'%'))
legend(-2,8,title = "muscles",
       xpd = TRUE,bty = "n",pch = 16,
       legend=c("BF","ST","SM","TA","EDL","Gas","Sol","Quad","Dia"),col = c("#FF7F24","#7FFFD4", "#CAFF70","#FFB90F","#BF3EFF","#0000FF","#FF4040","#006400","#FFD39B"),cex=0.6)
```

#PCA plot for muscle data expcept dia
```{r dpi=300}
dge_muscle <- expr[,colnames(expr) %in% rownames(dge$samples[dge$samples$Tissue %in% c("BF","ST","SM","TA","EDL","Gas","Sol","Quad"),])]

library(Polychrome)
col = as.character(createPalette(24,  c("#ff0000", "#00ff00", "#0000ff")))
cols=c("BF"=col[1],"ST"=col[2],"SM"=col[3],"TA"=col[4],"EDL"=col[5],"Gas"=col[6],"Sol"=col[7],"Quad"=col[8])

samplenames_muscle <- colnames(dge_muscle)
tissue <- sapply(samplenames_muscle,function(samplenames_muscle){
  as.character(dge.norm$samples[rownames(dge.norm$samples) == samplenames_muscle,"Tissue"])
})

group <- sapply(samplenames_muscle,function(samplenames_muscle){
  as.character(dge.norm$samples[rownames(dge.norm$samples) == samplenames_muscle,"Group"])
})
sex <- sapply(samplenames_muscle,function(samplenames_muscle){
  as.character(dge.norm$samples[rownames(dge.norm$samples) == samplenames_muscle,"Sex"])
})

library(factoextra)
muscle.pca <- prcomp(t(dge_muscle))#PCA
fviz_screeplot(muscle.pca, addlabels = TRUE)

pca_df_muscle<-as.data.frame(muscle.pca$x) 
muscle.pca.contrib <- muscle.pca$sdev %>% .^2 %>% {./sum(.) * 100} %>% .[1:4] %>% signif(digits = 4)
p <- ggplot(data = pca_df_muscle, aes(x = PC1, y = PC2)) +
  geom_point(size = 3,aes(color = as.character(tissue),shape = interaction(as.character(group),sex), fill = as.character(tissue))) + 
  scale_shape_manual(name="Group/Gender",values = c(16,21,17,24),
                     labels=c("RW,F","Sed,F","RW,M","Sed,M")) +
  scale_colour_manual(name="Tissue",values = cols) + 
  scale_fill_manual(name="Gender",values = rep("white",8),guide=FALSE) + 
  theme(panel.grid = element_blank(), panel.background = element_rect(color = 'black', fill = 'transparent'), 
    legend.key = element_rect(fill = 'transparent')) +  
  labs(x =  paste('PC1:',round(muscle.pca.contrib[1], 2),'%'), y = paste('PC2:',round(muscle.pca.contrib[2], 2),'%'), color = '') +
  ggtitle("PCA plot of muscles(Dia excluded)")

p
ggsave("/data/msun/projects/pandas/geraldine/01_PCA/2DPCA_muscle.pdf",p,width = 6.5,height = 5)

library(scatterplot3d) #3DPCA
pdf("/data/msun/projects/pandas/geraldine/01_preprocess/3DPCA_muscle.pdf",width = 7,height = 4.5)
color=as.character(group_muscle) %>% gsub("BF","#FF7F24",.) %>% gsub("ST","#7FFFD4",.) %>% gsub("SM","#CAFF70",.) %>% gsub("TA","#FFB90F",.) %>% gsub("EDL","#BF3EFF",.) %>% gsub("Gas","#0000FF",.) %>% gsub("Sol","#FF4040",.) %>% gsub("Quad","#006400",.) %>% gsub("Dia","#FFD39B",.)  
scatterplot3d(pca_df_muscle$PC1, pca_df_muscle$PC2, pca_df_muscle$PC3,       
              color = color, pch=16,
              angle=50,cex.symbols=1.5,cex.axis=0.6, 
             xlab = paste('PC1:',round(muscle.pca.contrib[1], 2),'%'), 
             ylab = paste('PC2:',round(muscle.pca.contrib[2], 2),'%'), 
             zlab = paste('PC3:',round(muscle.pca.contrib[3], 2),'%'))
legend(-2,8,title = "muscles",
       xpd = TRUE,bty = "n",pch = 16,
       legend=c("BF","ST","SM","TA","EDL","Gas","Sol","Quad","Dia"),col = c("#FF7F24","#7FFFD4", "#CAFF70","#FFB90F","#BF3EFF","#0000FF","#FF4040","#006400","#FFD39B"),cex=0.6)
```

#PCA plot for each sample
```{r dpi=300}
#1.do pca
library(factoextra)
library(tidyverse)
library(ggplot2)
library(grid)
library(ggforce)
library("FactoMineR")
list.pca <- expr.list %>% purrr::map( ~ prcomp(t(.)))  
#list.pca <- expr.list %>% purrr::map( ~ PCA(t(.),graph = FALSE))# normlized expr as input 
#contrib.pca <- list.pca %>% purrr::map(~ as.data.frame(get_eig(.)))
#3.2D PCA plot
p_names <- stringr::str_c(names(list.pca))
cols <- c("M" = "#05be78", "F" = "#b856d7")
paths <- paste("/data/msun/projects/pandas/geraldine/01_PCA/newPCA_bytissue/",names(list.pca),".pdf")
p2dpca <- pmap(list(list.pca,p_names,dge.list), ~ fviz_pca_biplot(..1, label="none",title = ..2,invisible ="var") +
            geom_point(size=4,aes(shape = interaction(as.character(..3$samples$Group), ..3$samples$ZT), color = as.character(..3$samples$Sex), fill = as.character(..3$samples$Sex))) +
            scale_shape_manual(name="Group/ZT", values=c(16,21,17,24),
                     labels=c("RW, 4", "Sed, 4",
                              "RW, 16", "Sed, 16")) + 
            theme_bw() +
            theme(legend.position = "none") +
            theme(text=element_text(size=15),
                  axis.text = element_text(color = "black",size=12.5)) + 
            geom_mark_ellipse(aes(color = as.factor(..3$samples$Sex)),expand = unit(0.5,"mm")) +
            #stat_ellipse(aes(group= ..3$samples$Group,lty=..3$samples$Group)) +
            scale_colour_manual(name="Gender", values = cols) + 
            scale_fill_manual(name="ZT", values=rep("white", length(cols)), guide=FALSE))
pwalk(list(paths, p2dpca), ggsave, width = 3.5, height = 3.5)


#arrange together
library(gridExtra)
grid_arrange_shared_legend_plotlist <- function(..., 
                                                plotlist=NULL,
                                                ncol = length(list(...)),
                                                nrow = NULL,
                                                position = c("bottom", "right")) {

  plots <- c(list(...), plotlist)

  if (is.null(nrow)) nrow = ceiling(length(plots)/ncol)

  position <- match.arg(position)
  g <- ggplotGrob(plots[[1]] + theme(legend.position = position))$grobs
  legend <- g[[which(sapply(g, function(x) x$name) == "guide-box")]]
  lheight <- sum(legend$height)
  lwidth <- sum(legend$width)
  gl <- lapply(plots, function(x) x + theme(legend.position="none"))
  gl <- c(gl, ncol = ncol, nrow = nrow)

  combined <- switch(position,
                     "bottom" = arrangeGrob(do.call(arrangeGrob, gl),
                                            legend,
                                            ncol = 1,
                                            heights = unit.c(unit(1, "npc") - lheight, lheight)),
                     "right" = arrangeGrob(do.call(arrangeGrob, gl),
                                           legend,
                                           ncol = 2,
                                           widths = unit.c(unit(1, "npc") - lwidth, lwidth)))

  grid.newpage()
  grid.draw(combined)

  # return gtable invisibly
  invisible(combined)
}
all2dpca <- grid_arrange_shared_legend_plotlist(plotlist=p2dpca,ncol = 4)
ggsave("/data/msun/projects/pandas/geraldine/01_PCA/2DPCA_bytissue/all2dpca.pdf",all2dpca,width = 20,height = 17)
  
#4.3D PCA plot
library(scatterplot3d) 
pca_df <- map(list.pca,~ as.data.frame(.$x))
pca_contrib <- map(list.pca, function(x){x$sdev %>% .^2 %>% {./sum(.) * 100} %>% .[1:4] %>% signif(digits = 4)})
colors <- c("hotpink", "#56B4E9")
shapes <- c(16,17)
p3dpca <- pmap(list(pca_df,dge.list,p_names,pca_contrib), function(first,second,third,fourth){
  s3d <- scatterplot3d(first$PC1, first$PC2, first$PC3, 
             color = colors[as.numeric(factor(second$samples$Sex))], 
             pch = shapes[as.numeric(factor(second$samples$Group))],
             angle=50,cex.symbols=2,cex.axis=0.6, main = third,
             xlab = paste('PC1:',round(fourth[1], 2),'%'), 
             ylab = paste('PC2:',round(fourth[2], 2),'%'), 
             zlab = paste('PC3:',round(fourth[3], 2),'%'))
  legend("bottom", legend = levels(factor(second$samples$Group)),
       pch = c(16, 17), 
      inset = -0.25, xpd = TRUE, horiz = TRUE)
  legend("bottomright", legend = levels(factor(second$samples$Sex)),
      col =  c("hotpink", "#56B4E9"), pch = 16, 
      inset = -0.25, xpd = TRUE, horiz = TRUE)
  text(s3d$xyz.convert(first), labels = second$samples$ZT,
     cex= 1, col = "black")}
)
p3dpca
```

